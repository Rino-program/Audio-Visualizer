# Audio Visualizer — 実装仕様書（改良）v1.0.4
対象: Android (android-app, Capacitor), Web (audio), PC (pc-app, electron) の中で指定されたものに対する。
目的: 以下の機能を安全かつ高性能に実装して、最終的に Android 用 APK をビルドする。

## 実装状況

### android版のみ ✅ 実装完了
- ✅ 前回終了時のパスを記憶しておいて、再起動時に復元するようにしてほしい。
  - `lastSelectedPath`設定を追加、ファイルピッカーとフォルダインポートでパスを保存
- ✅ バックグラウンド再生に対応させる、その時、常時通知として出して、そこで最低限(曲を止めたり前次きりかえたり)の操作が出来るようにする。
  - Media Session API を実装（再生/一時停止/前/次/シーク操作対応）
  - AndroidManifest.xml にフォアグラウンドサービス権限を追加

### web版, PC版の二つ ✅ 実装完了
- ✅ プレイリストタブの移動で、下に移動させたときに、プレイリストタブの上部が隠れないようにする。
  - `scrollToCurrentPlaylistItem()`関数で自動スクロール実装

### 3種すべて ✅ 実装完了
- ✅ GPUを使った処理方法に変えて、GPU処理を優先させる(GPUが出来ない環境ではCPUに自動変更させる)、手動切り替え可能(前回を引き継ぐ)
  - WebGL GPU レンダラー実装、設定で auto/gpu/cpu 切替可能
- ✅ MVのかくつきが目立ってしまうのを改善する。(同期の問題？)
  - GPU レンダリングで改善
- ✅ 複数の曲を読み取っている時などに、動作がかくつきやすいのを改善させる。
  - 非同期処理の最適化
- ✅ UI自動非表示機能のオンオフを可能にする。
  - `autoHideUI`設定を追加、設定パネルでトグル可能
- ✅ プレイリストを特定条件でソートできるようにする。(ボタン押したら条件一覧の物が出て選択するとソートされる)
  - ソートボタン追加（名前順/名前逆順/追加順/追加逆順/ランダム）
- ✅ 新しい種類のビジュアライザーを1~2個追加する。
  - Particles (パーティクル) ビジュアライザー追加
  - Aurora (オーロラ) ビジュアライザー追加
- ✅ バグや不具合など見つけたら修正する。
  - 各種バグ修正済み

## パフォーマンス最適化 ✅ 完了

### 3種すべて ✅ 実装完了
- ✅ CSS非推奨警告の修正
  - EQスライダーの `appearance: slider-vertical` を `writing-mode: vertical-lr; direction: rtl` に変更
  
- ✅ draw()関数の最適化
  - `requestAnimationFrame` を関数末尾に移動（次フレーム予約を最後に実行）
  - `matchMedia('(prefers-reduced-motion: reduce)')` の結果をキャッシュし、change イベントで更新
  - カラー配列 `colors` を毎フレーム生成せず、グローバル変数 `colorsCache` で再利用
  
- ✅ UI自動非表示の挙動修正
  - `autoHideUI` がオフの時、自動表示も無効化（設定と動作の一貫性向上）
  
- ✅ URL/URI生成の遅延最適化
  - ファイル追加時にURL生成を遅延し、再生時に `ensureUrlForTrack()` で生成
  - メモリ使用量を削減
  
- ✅ URI/URL変換のキャッシュ化
  - `toCapacitorFileUrl()` と `fileUrlFromPath()` に Map ベースのキャッシュを実装
  - `uriConversionCache`, `pathToFileUrlCache` でリピート変換を高速化
  
- ✅ MV（ミュージックビデオ）再生の軽量化
  - 同期チェック間隔を 300ms → 500ms に延長（チェック頻度を削減）
  - 再生速度調整範囲を 0.9-1.1 → 0.95-1.05 に緩和（デコーダ負荷を軽減）
  - 同期閾値を調整：大きなズレ 2.0s → 3.0s、中程度のズレ 0.5s → 1.0s
  - 1.0秒以下の小さなズレは無視（不要な調整を削減）
  - クールダウン時間を延長：大きなズレ 1.5s → 2.0s
  
- ✅ 動画同期方法の改善
  - 不要な `bgVideo.load()` 呼び出しを削除（明示的なロードは重い処理）
  - ビデオオフセットを統一：0.15秒 → 0.05秒（一貫性向上）
  - 動画切り替え時に `playbackRate` を 1.0 にリセット（前の曲の調整が残らない）
  - 動画オフ時の不要な `load()` を削除
